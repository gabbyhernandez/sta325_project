---
---
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(corrplot)
library(leaps)
library(car)
library(Metrics)
library(reshape2)
library(ggpubr)
library(moments)
library(dplyr)
library(missForest)
class(data)
library(glmnet)
```

```{r}
data <- read.csv("Life Expectancy Data.csv")
head(data)
```

```{r}
missing_counts <- data.frame(feature = factor(names(data)),
                    counts=sapply(data, function(x) sum(is.na(x))))


ggplot(missing_counts,
       aes(x=counts, y=reorder(feature, -counts), fill=counts)) +
                                  geom_bar(stat="identity") +
                                  ggtitle("Missing Value Counts for each Feature") +
                                  xlab("Missing Count") + ylab("Feature") +
                                  theme(axis.text.x=element_text(angle=20, hjust=1))+
                                  theme(text = element_text(size = 12))+
                                  scale_fill_continuous()

```

```{r}
plot(Life.expectancy~Schooling,data=data, main = "Schooling vs. Life Expectancy")
```

```{r}
hist(data$Life.expectancy, 
     xlab = "Life Expectancy",
     main = "Distribution of Life Expectancy")
summary(data$Life.expectancy)

```

```{r}
library(corrplot)
```

```{r}
columns_to_exclude <- c("Year", "Country","Status")
numericcol <- imputed_data %>% dplyr::select(-one_of(columns_to_exclude))
M = cor(numericcol)
# Set up a larger plotting area
par(mfrow = c(1, 1))  # You can adjust the number of rows and columns as needed
layout(matrix(1:1, nrow = 1, ncol = 1))

# Set the dimensions for the PNG file
png("correlation_plot.png", width = 2000, height = 2000, res = 150)

# Create a colorful number correlation plot
corrplot(M, method = 'number', type = 'upper', tl.col = 'black', tl.srt = 45, mar = c(0, 0, 2, 0))

# Close the PNG device
dev.off()
```

##Gabby EDA Explore Relationship Between Adult Mortality and Life Expectancy (Filled by Status) Looking for general trends between immunizations and life expectancy:

```{r}
data$Measles <- pmin(data$Measles, 1000)
data$Polio <- pmin(data$Polio, 1000)

plot(Life.expectancy~Hepatitis.B,data=data, col = ifelse(data$Status == "Developed", "blue", "red"), main = "Hepatitis B Immunization Among 1-Year-Olds (%) vs. Life Expectancy")
plot(Life.expectancy~Measles,data=data, fill = Status, main = "# Reported Measles cases (per 1000) vs. Life Expectancy")
plot(Life.expectancy~Polio,data=data, col = ifelse(data$Status == "Developed", "blue", "red"), main = "Polio (Pol3) Immunization Among 1-Year-Olds (%) vs. Life Expectancy")
plot(Life.expectancy~Diphtheria,data=data, col = ifelse(data$Status == "Developed", "blue", "red"), main = "DTP3 Immunization Among 1-Year-Olds (%) vs. Life Expectancy")
```

```{r}
immunization <- subset(data, Diphtheria < 20)
immunization
```

##Emily EDA

```{r}
# Mortality Group vs. Life Expectancy
# how to plot interaction effects when it's all quantitative variables?
plot(Life.expectancy~Adult.Mortality,data=data, main = "Adult Mortality vs. Life Expectancy")
plot(Life.expectancy~Adult.Mortality,data=data, col = ifelse(data$Status == "Developed", "blue", "red"), main = "Adult Mortality vs. Life Expectancy")
plot(Life.expectancy~Adult.Mortality,data=data, main = "Adult Mortality vs. Life Expectancy (subset)", xlim = c(0, 150))
# a lot of clustered groups in adult mortality 
plot(Life.expectancy~infant.deaths,data=data, main = "Infant Deaths vs. Life Expectancy")
plot(Life.expectancy~infant.deaths,data=data, main = "Infant Deaths vs. Life Expectancy (subset)", xlim = c(0,100))
# generally downward slope but more scattered
plot(Life.expectancy~under.five.deaths,data=data, main = "Under 5 Deaths vs. Life Expectancy")
plot(Life.expectancy~under.five.deaths,data=data, main = "Under 5 Deaths vs. Life Expectancy (subset)", xlim = c(0,1000))
# generally downward slope but more scattered
plot(Life.expectancy~HIV.AIDS,data=data, main = "Deaths Caused by HIV/AIDS vs. Life Expectancy")

```

```{r}
# countries where income composition = 0 
# If the income composition of resources component of the HDI is reported as 0 for a country, it suggests that the country's income is not derived from the specific factors or resources considered in that component of the HDI
under5death <- subset(data, under.five.deaths > 1000)
under5death
adultmortality <- subset(data, Adult.Mortality < 150)
adultmortality
```

```{r}
# Economical Group vs. Life Expectancy 
# Economical: %expenditure, total expenditure, GDP, income composition
plot(Life.expectancy~percentage.expenditure,data=data, main = "Percentage Expenditure vs. Life Expectancy")
plot(Life.expectancy~percentage.expenditure,data=data, main = "Percentage Expenditure vs. Life Expectancy (subset)", xlim = c(0,1000))
# need to find the # of countries that spend 0% of expenditure on health
# relatively linear 
# need to find how they define % expenditure (bc values greater than 100)
plot(Life.expectancy~Total.expenditure,data=data, main = "Total Expenditure vs. Life Expectancy")
# very scattered
plot(Life.expectancy~GDP,data=data, main = "GDP vs. Life Expectancy")
plot(Life.expectancy~GDP,data=data, main = "GDP vs. Life Expectancy (subset)", xlim = c(0,20000))
# relatively upward sloping 
# Assuming 'data' is your data frame and 'Status' is the categorical variable for coloring
plot(Life.expectancy~Income.composition.of.resources,data=data, main = "Income Composition of Resources vs. Life Expectancy")
plot(Life.expectancy ~ Income.composition.of.resources, data = data,
     pch = ifelse(data$Status == "Developed", 16, 17),
     main = "Income Composition of Resources vs. Life Expectancy",
     xlab = "Income Composition of Resources",
     ylab = "Life Expectancy",
     col = ifelse(data$Status == "Developed", "blue", "red"))
# higher = better (more diverse in income, more economic stability)
# remove total expenditure??
```

```{r}
# countries where income composition = 0 
# If the income composition of resources component of the HDI is reported as 0 for a country, it suggests that the country's income is not derived from the specific factors or resources considered in that component of the HDI
countries_with_zero_income <- subset(data, Income.composition.of.resources == 0)
countries_with_zero_income
```

How much has improvement in health (based on health predictors) lowered life expectancy?

-   "It has been observed that in the past 15 years , there has been a huge development in health sector resulting in improvement of human mortality rates especially in the developing nations in comparison to the past 30 years."

How does spending more money on health (ex: percentage expenditure or total expenditure) impact other factors that affect life expectancy?

##Jessica EDA

Social: status, alcohol, population, BMI, thinness(10-19), thinness(5-9), schooling

EDA: predictors vs response

```{r}
# Install and load necessary libraries
library(ggplot2)
library(dplyr)

model <- lm(data$`Life.expectancy` ~ `Status` + `Alcohol` + `Population` + `BMI` + thinness..1.19.years + thinness.5.9.years + `Schooling`, data = data)

# Summarize the model
summary(model)
```

```{r}
data$Status <- as.factor(data$Status)
plot(Life.expectancy ~ Status, data = data, 
     col = ifelse(data$Status == "Developed", "blue", "red"),
     main = "Status vs. Life Expectancy",
     xlab = "Status", ylab = "Life Expectancy")
plot(Life.expectancy~Alcohol,data=data, main = "Scatter Plot of Alcohol Consumption vs. Life Expectancy",
     xlab = "Alcohol Consumption", ylab = "Life Expectancy")

data$Population <- pmin(data$Population, 300000000)
plot(Life.expectancy~Population,data=data, main = "Scatter Plot of Population vs. Life Expectancy",
     xlab = "Population", ylab = "Life Expectancy")
summary(data$Population)
plot(Life.expectancy~BMI,data=data, main = "Scatter Plot of BMI vs. Life Expectancy",
     xlab = "BMI", ylab = "Life Expectancy")
plot(Life.expectancy~thinness..1.19.years,data=data, main = "Thinness 10-19 years vs. Life Expectancy",
     xlab = "Thinness 10-19 years", ylab = "Life Expectancy")
plot(Life.expectancy~thinness.5.9.years,data=data, main = "Scatter Plot of Thinness 5-9 years vs. Life Expectancy",
     xlab = "Thinness 5-9 years", ylab = "Life Expectancy")
plot(Life.expectancy~Schooling,data=data, main = "Schooling vs. Life Expectancy",
     xlab = "Schooling", ylab = "Life Expectancy")
```
##Data Wrangling

Need to Drop Country And Year First (Can add them back later)

```{r}
columns_to_exclude <- c("Year", "Country")

# Select all columns except the ones to exclude
le <- data %>% dplyr::select(-one_of(columns_to_exclude))
```

Change Necessary Variables Into Factors
```{r}
le$Status <- as.factor(le$Status)
le<- le %>%
  filter(Income.composition.of.resources > 0.2)
```

##Filling In Missing Values using imputation


The missForest package is specifically designed for imputing missing data in datasets with mixed types of variables (numeric and categorical). It uses a random forest-based imputation method.

```{r}
imputed_data <- missForest(le)

imputed_data <- imputed_data$ximp
```

##Split Data into Training and Testing

```{r}
set.seed(123) 

train_indices <- sample(seq_len(nrow(imputed_data)), size = 0.7 * nrow(imputed_data))

data_train <- imputed_data[train_indices, ]

data_test <- imputed_data[-train_indices, ]
```


##Group Lasso
Group Lasso code:

```{r}
library(grpreg)
X <- as.matrix(imputed_data[, c("Hepatitis.B", "Polio", "Diphtheria", "Adult.Mortality", "under.five.deaths", "HIV.AIDS", "percentage.expenditure", "GDP", "Income.composition.of.resources", "Alcohol", "Population", "BMI")])
y <- imputed_data$Life.expectancy

# Specify group indices
group_indices <- list(c("Hepatitis.B", "Polio", "Diphtheria"), c("Adult.Mortality", "under.five.deaths", "HIV.AIDS"), c("GDP", "Income.composition.of.resources"), c("Alcohol", "Population", "BMI"))

# Perform linear regression with group lasso
fit <- grpreg(X, y, groups = group_indices, penalty = "grLasso")

# Display coefficients
coef(fit)

#Find best lambda and coefficients
set.seed(123)

cv_fit <- cv.grpreg(X, y, groups = group_indices, penalty = "grLasso")
best_lambda <- cv_fit$lambda.min
best_coef <- coef(cv_fit, s = best_lambda)
best_lambda
best_coef
```

##Individual Lasso
```{r}
# Assuming 'Status' is a factor variable
imputed_data$Status <- as.factor(imputed_data$Status)

# Select variables for regression
X <- as.matrix(imputed_data[, c("Hepatitis.B", "Polio", "Diphtheria", "Adult.Mortality", "under.five.deaths", "HIV.AIDS", "percentage.expenditure", "GDP", "Income.composition.of.resources", "Alcohol", "Population", "BMI")])
y <- imputed_data$Life.expectancy

# Convert 'Status' to numeric (0 or 1)
imputed_data$Status_numeric <- as.numeric(imputed_data$Status) - 1

# Combine predictors
predictors <- c("Hepatitis.B", "Polio", "Diphtheria", "Adult.Mortality", "under.five.deaths", "HIV.AIDS", "percentage.expenditure", "GDP", "Income.composition.of.resources", "Alcohol", "Population", "BMI")

# Create interaction terms
interaction_terms <- c()
for (var_name in predictors) {
  interaction_name <- paste0(var_name, "_Status")
  imputed_data[[interaction_name]] <- imputed_data[[var_name]] * imputed_data$Status_numeric
  interaction_terms <- c(interaction_terms, interaction_name)
}

# Combine predictors and interaction terms
all_predictors <- c(predictors, interaction_terms)

# Perform linear regression with Lasso using glmnet
library(glmnet)

# Fit model with Lasso
fit <- cv.glmnet(as.matrix(imputed_data[, all_predictors, drop = FALSE]), y, alpha = 1, lambda.min.ratio = 1e-8, standardize = FALSE)

# Display coefficients for the optimal lambda
best_lambda <- fit$lambda.min
cat("Optimal lambda:", best_lambda, "\n")
coef(fit, s = "lambda.min")

```

